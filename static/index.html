<!-- Save this file as static/index.html in your project directory -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OllamaRAG - PDF RAG System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 15px;
            margin-bottom: 15px;
        }
        .user-message {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 80%;
            align-self: flex-end;
            margin-left: auto;
        }
        .assistant-message {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 80%;
        }
        .chunks-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .collection-badge {
            cursor: pointer;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <h1 class="mb-4">OllamaRAG - PDF RAG System</h1>
        
        <div class="row">
            <div class="col-md-8">
                <!-- Chat Interface -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Chat</span>
                        <span id="current-collection" class="badge bg-primary">No collection selected</span>
                    </div>
                    <div class="card-body">
                        <div id="chat-container" class="chat-container d-flex flex-column">
                            <div class="assistant-message">
                                Welcome to OllamaRAG! Please upload a PDF or select a collection to start chatting.
                            </div>
                        </div>
                        <form id="chat-form">
                            <div class="input-group">
                                <input type="text" id="query-input" class="form-control" placeholder="Ask a question about your document..." disabled>
                                <button type="submit" class="btn btn-primary" disabled id="send-btn">
                                    <span id="send-text">Send</span>
                                    <span id="loading-indicator" class="loading d-none"></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Upload Interface -->
                <div class="card">
                    <div class="card-header">Upload PDF</div>
                    <div class="card-body">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="pdf-file" class="form-label">Select PDF file</label>
                                <input class="form-control" type="file" id="pdf-file" accept=".pdf">
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label for="chunk-size" class="form-label">Chunk Size</label>
                                    <input type="number" class="form-control" id="chunk-size" value="1000">
                                </div>
                                <div class="col">
                                    <label for="chunk-overlap" class="form-label">Overlap</label>
                                    <input type="number" class="form-control" id="chunk-overlap" value="500">
                                </div>
                                <div class="col">
                                    <label for="max-workers" class="form-label">Workers</label>
                                    <input type="number" class="form-control" id="max-workers" value="4">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" id="upload-btn">
                                <span id="upload-text">Upload</span>
                                <span id="upload-loading" class="loading d-none"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Stats Card -->
                <div class="card mb-4">
                    <div class="card-header">System Stats</div>
                    <div class="card-body">
                        <div id="stats-container">
                            <p><strong>LLM Model:</strong> <span id="llm-model">Loading...</span></p>
                            <p><strong>Embedding Model:</strong> <span id="embedding-model">Loading...</span></p>
                            <p><strong>Context Window:</strong> <span id="context-window">Loading...</span></p>
                            <button id="refresh-stats" class="btn btn-sm btn-outline-secondary">Refresh</button>
                        </div>
                    </div>
                </div>
                
                <!-- Collections Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Collections</span>
                        <button id="refresh-collections" class="btn btn-sm btn-outline-secondary">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div id="collections-container">
                            <p>Loading collections...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Config Card -->
                <div class="card">
                    <div class="card-header">Configuration</div>
                    <div class="card-body">
                        <form id="config-form">
                            <div class="mb-3">
                                <label for="llm-model-select" class="form-label">LLM Model</label>
                                <select class="form-select" id="llm-model-select">
                                    <option value="tinyllama">Loading models...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="embedding-model-select" class="form-label">Embedding Model</label>
                                <select class="form-select" id="embedding-model-select">
                                    <option value="mxbai-embed-large">Loading models...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="context-window-input" class="form-label">Context Window</label>
                                <input type="number" class="form-control" id="context-window-input" value="2048">
                            </div>
                            <button type="submit" class="btn btn-primary">Update Configuration</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Relevant Chunks Modal -->
        <div class="modal fade" id="chunksModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Relevant Chunks</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="chunks-container" class="chunks-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API URL
// API URL
const API_URL = "http://localhost:8000";

// DOM Elements
const chatContainer = document.getElementById('chat-container');
const chatForm = document.getElementById('chat-form');
const queryInput = document.getElementById('query-input');
const sendBtn = document.getElementById('send-btn');
const uploadBtn = document.getElementById('upload-btn');
const uploadForm = document.getElementById('upload-form');
const currentCollection = document.getElementById('current-collection');
const collectionsContainer = document.getElementById('collections-container');
const statsContainer = document.getElementById('stats-container');
const chunksContainer = document.getElementById('chunks-container');
const configForm = document.getElementById('config-form');
const llmModelSelect = document.getElementById('llm-model-select');
const embeddingModelSelect = document.getElementById('embedding-model-select');
const contextWindowInput = document.getElementById('context-window-input');
const refreshCollections = document.getElementById('refresh-collections');
const refreshStats = document.getElementById('refresh-stats');
const fileInput = document.getElementById('pdf-file');

// UI state
let activeChatEnabled = false;
let chunksModal;

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    // Initialize Bootstrap modal
    chunksModal = new bootstrap.Modal(document.getElementById('chunksModal'));
    
    // Load initial data
    await Promise.all([
        fetchStats(),
        fetchCollections(),
        fetchAvailableModels()
    ]);
    
    // Check connection to Ollama server
    await testConnection();
    
    // Set up file input listener for upload button
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
            uploadBtn.disabled = false;
        } else {
            uploadBtn.disabled = true;
        }
    });
    
    // Set up refresh buttons
    refreshCollections.addEventListener('click', fetchCollections);
    refreshStats.addEventListener('click', fetchStats);
    
    // Set up config form
    configForm.addEventListener('submit', updateConfig);
});

// Test connection to Ollama server
async function testConnection() {
    try {
        const response = await fetch(`${API_URL}/test-connection`);
        const data = await response.json();
        
        if (data.status === 'error') {
            addMessage('assistant', `⚠️ ${data.message} Make sure Ollama is running with 'ollama serve'`);
        }
    } catch (error) {
        addMessage('assistant', '⚠️ Failed to connect to the API server. Make sure the backend is running.');
    }
}

// Fetch available models from Ollama
async function fetchAvailableModels() {
    try {
        const response = await fetch(`${API_URL}/available-models`);
        if (!response.ok) throw new Error('Failed to fetch models');
        
        const data = await response.json();
        
        // Populate LLM model dropdown
        llmModelSelect.innerHTML = '';
        data.llm_models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            llmModelSelect.appendChild(option);
        });
        
        // Populate embedding model dropdown
        embeddingModelSelect.innerHTML = '';
        data.embedding_models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            embeddingModelSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error fetching models:', error);
    }
}

// Fetch system stats
async function fetchStats() {
    try {
        const response = await fetch(`${API_URL}/stats`);
        if (!response.ok) throw new Error('Failed to fetch stats');
        
        const data = await response.json();
        
        document.getElementById('llm-model').textContent = data.llm_model;
        document.getElementById('embedding-model').textContent = data.embedding_model;
        document.getElementById('context-window').textContent = data.context_window;
        
        // Update form values
        llmModelSelect.value = data.llm_model;
        embeddingModelSelect.value = data.embedding_model;
        contextWindowInput.value = data.context_window;
        
        // Update current collection
        if (data.current_collection) {
            currentCollection.textContent = data.current_collection;
            currentCollection.classList.remove('bg-primary');
            currentCollection.classList.add('bg-success');
            enableChat();
        } else {
            currentCollection.textContent = 'No collection selected';
            currentCollection.classList.remove('bg-success');
            currentCollection.classList.add('bg-primary');
            disableChat();
        }
    } catch (error) {
        console.error('Error fetching stats:', error);
    }
}

// Fetch collections
async function fetchCollections() {
    try {
        const response = await fetch(`${API_URL}/collections`);
        if (!response.ok) throw new Error('Failed to fetch collections');
        
        const data = await response.json();
        
        if (data.collections.length === 0) {
            collectionsContainer.innerHTML = '<p>No collections available. Upload a PDF to create one.</p>';
            return;
        }
        
        collectionsContainer.innerHTML = '<div class="list-group">';
        data.collections.forEach(collection => {
            const badge = collection.active ? 'bg-success' : 'bg-secondary';
            collectionsContainer.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="collection-badge" data-collection="${collection.name}">${collection.name}</span>
                    <span>
                        <span class="badge ${badge} me-1">${collection.count} chunks</span>
                        <button class="btn btn-sm btn-danger delete-collection" data-collection="${collection.name}">
                            <small>Delete</small>
                        </button>
                    </span>
                </div>
            `;
        });
        collectionsContainer.innerHTML += '</div>';
        
        // Add event listeners to collection badges for switching
        document.querySelectorAll('.collection-badge').forEach(badge => {
            badge.addEventListener('click', () => switchCollection(badge.dataset.collection));
        });
        
        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-collection').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCollection(button.dataset.collection);
            });
        });
    } catch (error) {
        console.error('Error fetching collections:', error);
        collectionsContainer.innerHTML = '<p>Error loading collections</p>';
    }
}

// Switch to a different collection
async function switchCollection(collectionName) {
    try {
        const response = await fetch(`${API_URL}/switch-collection/${collectionName}`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to switch collection');
        
        const data = await response.json();
        addMessage('assistant', `Switched to collection: ${collectionName} with ${data.count} chunks`);
        
        // Update UI
        currentCollection.textContent = collectionName;
        currentCollection.classList.remove('bg-primary');
        currentCollection.classList.add('bg-success');
        
        // Enable chat
        enableChat();
        
        // Refresh collections to update active status
        await fetchCollections();
    } catch (error) {
        console.error('Error switching collection:', error);
        addMessage('assistant', `Error switching to collection: ${error.message}`);
    }
}

// Delete a collection
async function deleteCollection(collectionName) {
    if (!confirm(`Are you sure you want to delete the collection "${collectionName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/collections/${collectionName}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete collection');
        
        const data = await response.json();
        addMessage('assistant', data.message);
        
        // Refresh stats and collections
        await Promise.all([fetchStats(), fetchCollections()]);
    } catch (error) {
        console.error('Error deleting collection:', error);
        addMessage('assistant', `Error deleting collection: ${error.message}`);
    }
}

// Enable chat interface
function enableChat() {
    queryInput.disabled = false;
    sendBtn.disabled = false;
    activeChatEnabled = true;
}

// Disable chat interface
function disableChat() {
    queryInput.disabled = true;
    sendBtn.disabled = true;
    activeChatEnabled = false;
}

// Add a message to the chat container
function addMessage(sender, message, chunks = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = sender === 'user' ? 'user-message' : 'assistant-message';
    messageDiv.innerHTML = message.replace(/\n/g, '<br>');
    
    // Add "View Sources" button if chunks are provided
    if (chunks && chunks.length > 0) {
        const sourceButton = document.createElement('button');
        sourceButton.className = 'btn btn-sm btn-outline-secondary mt-2';
        sourceButton.textContent = 'View Sources';
        sourceButton.addEventListener('click', () => {
            showChunks(chunks);
            chunksModal.show();
        });
        messageDiv.appendChild(sourceButton);
    }
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Show relevant chunks in modal
function showChunks(chunks) {
    chunksContainer.innerHTML = '';
    
    chunks.forEach((chunk, index) => {
        const chunkDiv = document.createElement('div');
        chunkDiv.className = 'card mb-2';
        chunkDiv.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <small>Chunk ${index + 1}</small>
                <span class="badge bg-info">Similarity: ${(chunk.similarity * 100).toFixed(1)}%</span>
            </div>
            <div class="card-body">
                <p class="card-text" style="font-size: 0.9rem;">${chunk.text.substring(0, 300)}...</p>
            </div>
        `;
        chunksContainer.appendChild(chunkDiv);
    });
}

// Update configuration
async function updateConfig(e) {
    e.preventDefault();
    
    const llmModel = llmModelSelect.value;
    const embeddingModel = embeddingModelSelect.value;
    const contextWindow = parseInt(contextWindowInput.value);
    
    try {
        const response = await fetch(`${API_URL}/config`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                llm_model: llmModel,
                embedding_model: embeddingModel,
                context_window: contextWindow
            })
        });
        
        if (!response.ok) throw new Error('Failed to update configuration');
        
        const data = await response.json();
        addMessage('assistant', data.message);
        
        // Refresh stats
        await fetchStats();
    } catch (error) {
        console.error('Error updating configuration:', error);
        addMessage('assistant', `Error updating configuration: ${error.message}`);
    }
}

// Chat form submission
chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const query = queryInput.value.trim();
    if (!query) return;
    
    // Add user message to chat
    addMessage('user', query);
    
    // Clear input
    queryInput.value = '';
    
    // Show loading indicator
    document.getElementById('send-text').classList.add('d-none');
    document.getElementById('loading-indicator').classList.remove('d-none');
    sendBtn.disabled = true;
    
    try {
        const response = await fetch(`${API_URL}/query`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query,
                top_k: 5
            })
        });
        
        if (!response.ok) throw new Error('Query failed');
        
        const data = await response.json();
        
        // Add assistant response to chat
        addMessage('assistant', data.response, data.relevant_chunks);
    } catch (error) {
        console.error('Error querying:', error);
        addMessage('assistant', `Error: ${error.message}`);
    } finally {
        // Hide loading indicator
        document.getElementById('send-text').classList.remove('d-none');
        document.getElementById('loading-indicator').classList.add('d-none');
        sendBtn.disabled = false;
    }
});

// Upload form submission
uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!fileInput.files.length) {
        alert('Please select a PDF file');
        return;
    }
    
    const file = fileInput.files[0];
    const chunkSize = document.getElementById('chunk-size').value;
    const chunkOverlap = document.getElementById('chunk-overlap').value;
    const maxWorkers = document.getElementById('max-workers').value;
    
    // Show loading indicator
    document.getElementById('upload-text').classList.add('d-none');
    document.getElementById('upload-loading').classList.remove('d-none');
    uploadBtn.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('chunk_size', chunkSize);
        formData.append('chunk_overlap', chunkOverlap);
        formData.append('max_workers', maxWorkers);
        
        const response = await fetch(`${API_URL}/upload-pdf`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) throw new Error('Upload failed');
        
        const data = await response.json();
        addMessage('assistant', data.message);
        
        // Refresh collections after successful upload
        setTimeout(fetchCollections, 2000);
    } catch (error) {
        console.error('Error uploading file:', error);
        addMessage('assistant', `Error uploading file: ${error.message}`);
    } finally {
        // Hide loading indicator
        document.getElementById('upload-text').classList.remove('d-none');
        document.getElementById('upload-loading').classList.add('d-none');
        uploadBtn.disabled = false;
        
        // Clear file input
        fileInput.value = '';
    }
});
    </script>
</body>